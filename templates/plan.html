{% extends "base.html" %}

{% block title %}N칛ringsplan - Matplanerare{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-clipboard-plus me-2"></i>Skapa ny n칛ringsplan
                    </h5>
                </div>
                <div class="card-body">
                    <form id="planForm">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Namn p친 plan</label>
                            <input type="text" class="form-control" name="name" value="Min n칛ringsplan" required>
                        </div>
                        
                        <!-- ALLERGIER & INTOLERANSER -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3">
                                <i class="bi bi-shield-exclamation me-2"></i>Allergier & Kostrestriktioner
                            </h6>
                            <p class="text-muted small mb-3">
                                V칛lj dina allergier/intoleranser. Generatorn kommer aldrig f칬resl친 produkter som bryter mot dessa.
                            </p>
                            <div class="row g-2">
                                {% for key, allergy in allergens.items() %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="form-check allergy-check">
                                        <input class="form-check-input" type="checkbox" name="allergies" 
                                               value="{{ key }}" id="allergy_{{ key }}">
                                        <label class="form-check-label" for="allergy_{{ key }}">
                                            <span class="me-1">{{ allergy.icon }}</span>
                                            {{ allergy.name }}
                                            <small class="text-muted d-block">{{ allergy.description }}</small>
                                        </label>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h6 class="text-muted mb-3">
                            <i class="bi bi-fire me-2"></i>Makron칛rings칛mnen (per dag)
                        </h6>
                        
                        <div class="alert alert-info small mb-3">
                            <i class="bi bi-info-circle me-2"></i>
                            <strong>Om m친ll칛gen:</strong> 
                            <span class="badge bg-secondary">M친l</span> = f칬rs칬k uppn친 detta v칛rde,
                            <span class="badge bg-success">Min</span> = minst detta v칛rde,
                            <span class="badge bg-warning text-dark">Max</span> = h칬gst detta v칛rde,
                            <span class="badge bg-light text-dark">Ignorera</span> = ingen preferens
                            <br><small class="text-muted mt-1 d-block">
                                丘멆잺 Att s칛tta 0 som exakt m친l fungerar oftast inte d친 n칛stan alla livsmedel inneh친ller naturligt sm친 m칛ngder av n칛rings칛mnen.
                                Anv칛nd "Max" med l친gt v칛rde eller "Ignorera" ist칛llet.
                            </small>
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Kalorier (kcal)
                                    <span class="ms-auto badge bg-light text-dark rdi-badge" 
                                          data-bs-toggle="tooltip" 
                                          title="RDI: {{ rdi_values.calories.value }} {{ rdi_values.calories.unit }} - {{ rdi_values.calories.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.calories.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="calories" value="2000" min="0" max="5000">
                                    <select class="form-select" name="calories_mode" style="max-width: 110px;">
                                        <option value="target" selected>M친l</option>
                                        <option value="min">Min</option>
                                        <option value="max">Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Protein (g)
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="RDI: {{ rdi_values.protein.value }} {{ rdi_values.protein.unit }} - {{ rdi_values.protein.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.protein.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="protein" value="60" min="0" max="300">
                                    <select class="form-select" name="protein_mode" style="max-width: 110px;">
                                        <option value="target">M친l</option>
                                        <option value="min" selected>Min</option>
                                        <option value="max">Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Kolhydrater (g)
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="RDI: {{ rdi_values.carbs.value }} {{ rdi_values.carbs.unit }} - {{ rdi_values.carbs.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.carbs.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="carbs" value="280" min="0" max="500">
                                    <select class="form-select" name="carbs_mode" style="max-width: 110px;">
                                        <option value="target" selected>M친l</option>
                                        <option value="min">Min</option>
                                        <option value="max">Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Fett (g)
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="RDI: {{ rdi_values.fat.value }} {{ rdi_values.fat.unit }} - {{ rdi_values.fat.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.fat.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="fat" value="70" min="0" max="200">
                                    <select class="form-select" name="fat_mode" style="max-width: 110px;">
                                        <option value="target">M친l</option>
                                        <option value="min">Min</option>
                                        <option value="max" selected>Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Fiber (g)
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="RDI: {{ rdi_values.fiber.value }} {{ rdi_values.fiber.unit }} - {{ rdi_values.fiber.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.fiber.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="fiber" value="30" min="0" max="60">
                                    <select class="form-select" name="fiber_mode" style="max-width: 110px;">
                                        <option value="target">M친l</option>
                                        <option value="min" selected>Min</option>
                                        <option value="max">Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Socker (g)
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="RDI: {{ rdi_values.sugar.value }} {{ rdi_values.sugar.unit }} - {{ rdi_values.sugar.description }}">
                                        <i class="bi bi-info-circle"></i> Max: {{ rdi_values.sugar.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="sugar" value="50" min="0" max="200">
                                    <select class="form-select" name="sugar_mode" style="max-width: 110px;">
                                        <option value="target">M친l</option>
                                        <option value="min">Min</option>
                                        <option value="max" selected>Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <h6 class="text-muted mb-3">
                            <i class="bi bi-capsule me-2"></i>Vitaminer & Mineraler (per dag)
                        </h6>
                        
                        <div class="alert alert-warning small mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <strong>Disclaimer:</strong> N칛ringsv칛rdena nedan 칛r generella riktlinjer f칬r friska vuxna, 
                            <strong>ej medicinska r친d</strong>. Individuella behov kan variera. Konsultera l칛kare/dietist vid specifika behov.
                        </div>
                        
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Vitamin C (mg)
                                    <span class="badge bg-success ms-1">游볹游꼙</span>
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="{{ rdi_values.vitamin_c.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.vitamin_c.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="vitamin_c" value="80" min="0" max="2000">
                                    <select class="form-select" name="vitamin_c_mode" style="max-width: 110px;">
                                        <option value="target">M친l</option>
                                        <option value="min" selected>Min</option>
                                        <option value="max">Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Vitamin D (췃g)
                                    <span class="badge bg-primary ms-1">游游볰</span>
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="{{ rdi_values.vitamin_d.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.vitamin_d.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="vitamin_d" value="15" min="0" max="100">
                                    <select class="form-select" name="vitamin_d_mode" style="max-width: 110px;">
                                        <option value="target">M친l</option>
                                        <option value="min" selected>Min</option>
                                        <option value="max">Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    Kalcium (mg)
                                    <span class="badge bg-light text-dark ms-1">游볱游</span>
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="{{ rdi_values.calcium.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.calcium.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="calcium" value="900" min="0" max="2500">
                                    <select class="form-select" name="calcium_mode" style="max-width: 110px;">
                                        <option value="target">M친l</option>
                                        <option value="min" selected>Min</option>
                                        <option value="max">Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label d-flex align-items-center">
                                    J칛rn (mg)
                                    <span class="badge bg-danger ms-1">游볼游삊</span>
                                    <span class="ms-auto badge bg-light text-dark rdi-badge"
                                          data-bs-toggle="tooltip"
                                          title="{{ rdi_values.iron.description }}">
                                        <i class="bi bi-info-circle"></i> RDI: {{ rdi_values.iron.value }}
                                    </span>
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="iron" value="12" min="0" max="50">
                                    <select class="form-select" name="iron_mode" style="max-width: 110px;">
                                        <option value="target">M친l</option>
                                        <option value="min" selected>Min</option>
                                        <option value="max">Max</option>
                                        <option value="ignore">Ignorera</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save me-2"></i>Spara plan
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="bi bi-collection me-2"></i>Sparade planer
                    </h5>
                </div>
                <div class="card-body">
                    <div id="plansList">
                        {% if plans %}
                            {% for plan in plans %}
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                <div>
                                    <strong>{{ plan.name }}</strong>
                                    <br>
                                    <small class="text-muted">{{ plan.calories_target }} kcal/dag</small>
                                    {% if plan.get_allergies_list() %}
                                    <br><small class="text-info">
                                        {% for allergy in plan.get_allergies_list()[:3] %}
                                        {{ allergens.get(allergy, {}).get('icon', '游뛂') }}
                                        {% endfor %}
                                        {% if plan.get_allergies_list()|length > 3 %}+{{ plan.get_allergies_list()|length - 3 }}{% endif %}
                                    </small>
                                    {% endif %}
                                </div>
                                <div>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deletePlan({{ plan.id }})">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted text-center mb-0">
                                <i class="bi bi-inbox me-2"></i>Inga planer sparade 칛n
                            </p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="bi bi-info-circle me-2"></i>F칬rdefinierade m친l
                    </h6>
                </div>
                <div class="card-body">
                    <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="loadPreset('standard')">
                        Standard (2000 kcal)
                    </button>
                    <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="loadPreset('weightloss')">
                        Viktminskning (1500 kcal)
                    </button>
                    <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="loadPreset('muscle')">
                        Muskelbyggande (2500 kcal)
                    </button>
                    <button class="btn btn-outline-secondary btn-sm w-100 mb-2" onclick="loadPreset('lowcarb')">
                        L친gkolhydrat
                    </button>
                    <button class="btn btn-outline-success btn-sm w-100" onclick="loadPreset('vegetarian')">
                        游볿 Vegetarisk
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.allergy-check {
    padding: 10px;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    transition: all 0.2s;
}
.allergy-check:hover {
    background-color: #f8f9fa;
}
.allergy-check input:checked + label {
    color: #dc3545;
    font-weight: 500;
}
.allergy-check:has(input:checked) {
    border-color: #dc3545;
    background-color: #fff5f5;
}
.rdi-badge {
    cursor: help;
    font-size: 0.75rem;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Aktivera tooltips
var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
    return new bootstrap.Tooltip(tooltipTriggerEl)
});

const presets = {
    standard: { 
        name: 'Standard', 
        calories: 2000, protein: 60, carbs: 280, fat: 70, fiber: 30, sugar: 50,
        calories_mode: 'target', protein_mode: 'min', carbs_mode: 'target', 
        fat_mode: 'max', fiber_mode: 'min', sugar_mode: 'max',
        allergies: []
    },
    weightloss: { 
        name: 'Viktminskning', 
        calories: 1500, protein: 80, carbs: 150, fat: 50, fiber: 35, sugar: 30,
        calories_mode: 'max', protein_mode: 'min', carbs_mode: 'max', 
        fat_mode: 'max', fiber_mode: 'min', sugar_mode: 'max',
        allergies: []
    },
    muscle: { 
        name: 'Muskelbyggande', 
        calories: 2500, protein: 150, carbs: 300, fat: 80, fiber: 30, sugar: 60,
        calories_mode: 'min', protein_mode: 'min', carbs_mode: 'target', 
        fat_mode: 'target', fiber_mode: 'min', sugar_mode: 'max',
        allergies: []
    },
    lowcarb: { 
        name: 'L친gkolhydrat', 
        calories: 1800, protein: 100, carbs: 50, fat: 120, fiber: 25, sugar: 20,
        calories_mode: 'target', protein_mode: 'min', carbs_mode: 'max', 
        fat_mode: 'target', fiber_mode: 'min', sugar_mode: 'max',
        allergies: []
    },
    vegetarian: { 
        name: 'Vegetarisk', 
        calories: 2000, protein: 55, carbs: 300, fat: 65, fiber: 35, sugar: 50,
        calories_mode: 'target', protein_mode: 'min', carbs_mode: 'target', 
        fat_mode: 'max', fiber_mode: 'min', sugar_mode: 'max',
        allergies: ['vegetarian']
    }
};

function loadPreset(preset) {
    const p = presets[preset];
    document.querySelector('[name="name"]').value = p.name;
    document.querySelector('[name="calories"]').value = p.calories;
    document.querySelector('[name="protein"]').value = p.protein;
    document.querySelector('[name="carbs"]').value = p.carbs;
    document.querySelector('[name="fat"]').value = p.fat;
    document.querySelector('[name="fiber"]').value = p.fiber;
    document.querySelector('[name="sugar"]').value = p.sugar;
    
    // S칛tt modes
    if (p.calories_mode) document.querySelector('[name="calories_mode"]').value = p.calories_mode;
    if (p.protein_mode) document.querySelector('[name="protein_mode"]').value = p.protein_mode;
    if (p.carbs_mode) document.querySelector('[name="carbs_mode"]').value = p.carbs_mode;
    if (p.fat_mode) document.querySelector('[name="fat_mode"]').value = p.fat_mode;
    if (p.fiber_mode) document.querySelector('[name="fiber_mode"]').value = p.fiber_mode;
    if (p.sugar_mode) document.querySelector('[name="sugar_mode"]').value = p.sugar_mode;
    
    // S칛tt allergier
    document.querySelectorAll('[name="allergies"]').forEach(cb => {
        cb.checked = p.allergies && p.allergies.includes(cb.value);
    });
}

document.getElementById('planForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    
    // Samla allergier
    const allergies = [];
    document.querySelectorAll('[name="allergies"]:checked').forEach(cb => {
        allergies.push(cb.value);
    });
    
    const data = {
        name: formData.get('name'),
        allergies: allergies,
        calories: parseInt(formData.get('calories')),
        protein: parseInt(formData.get('protein')),
        carbs: parseInt(formData.get('carbs')),
        fat: parseInt(formData.get('fat')),
        fiber: parseInt(formData.get('fiber')),
        sugar: parseInt(formData.get('sugar')),
        calories_mode: formData.get('calories_mode'),
        protein_mode: formData.get('protein_mode'),
        carbs_mode: formData.get('carbs_mode'),
        fat_mode: formData.get('fat_mode'),
        fiber_mode: formData.get('fiber_mode'),
        sugar_mode: formData.get('sugar_mode'),
        vitamin_c: parseInt(formData.get('vitamin_c')),
        vitamin_d: parseInt(formData.get('vitamin_d')),
        calcium: parseInt(formData.get('calcium')),
        iron: parseInt(formData.get('iron')),
        vitamin_c_mode: formData.get('vitamin_c_mode'),
        vitamin_d_mode: formData.get('vitamin_d_mode'),
        calcium_mode: formData.get('calcium_mode'),
        iron_mode: formData.get('iron_mode')
    };
    
    const response = await fetch('/api/plans', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    });
    
    if (response.ok) {
        location.reload();
    }
});

async function deletePlan(id) {
    if (confirm('Vill du ta bort denna plan?')) {
        await fetch(`/api/plans/${id}`, { method: 'DELETE' });
        location.reload();
    }
}
</script>
{% endblock %}
