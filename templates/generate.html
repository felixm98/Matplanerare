{% extends "base.html" %}

{% block title %}Generera ink칬pslista - Matplanerare{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-magic me-2"></i>Generera ink칬pslista automatiskt
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        V칛lj en n칛ringsplan och hur l칛nge du vill handla f칬r. Appen genererar
                        en optimerad ink칬pslista baserad p친 dina n칛ringsbehov.
                    </p>

                    <form id="generateForm">
                        <div class="mb-4">
                            <label class="form-label fw-bold">V칛lj n칛ringsplan</label>
                            {% if plans %}
                            <select class="form-select form-select-lg" name="plan_id" required>
                                {% for plan in plans %}
                                <option value="{{ plan.id }}" 
                                        data-allergies="{{ plan.get_allergies_list()|join(',') if plan.get_allergies_list() else '' }}">
                                    {{ plan.name }} ({{ plan.calories_target }} kcal/dag)
                                    {% if plan.get_allergies_list() %}
                                        - {% for a in plan.get_allergies_list()[:3] %}{{ allergens.get(a, {}).get('icon', '') }}{% endfor %}
                                    {% endif %}
                                </option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Du har ingen n칛ringsplan. 
                                <a href="/plan">Skapa en f칬rst</a>.
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Tidsperiod</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" 
                                               name="days" value="7" min="1" max="30">
                                        <span class="input-group-text">dagar</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="setDays(3)">3 dagar</button>
                                        <button type="button" class="btn btn-outline-secondary active" onclick="setDays(7)">1 vecka</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="setDays(14)">2 veckor</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-people me-2"></i>Antal personer i hush친llet
                                </label>
                                <div class="input-group">
                                    <button type="button" class="btn btn-outline-secondary" onclick="changeHouseholdSize(-1)">-</button>
                                    <input type="number" class="form-control text-center" name="household_size" value="1" min="1" max="10">
                                    <button type="button" class="btn btn-outline-secondary" onclick="changeHouseholdSize(1)">+</button>
                                </div>
                                <small class="text-muted">Kvantiteter skalas automatiskt</small>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">
                                    <i class="bi bi-wallet2 me-2"></i>Budget (valfritt)
                                </label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="budget" placeholder="Ingen gr칛ns" min="0" step="50">
                                    <span class="input-group-text">kr</span>
                                </div>
                                <small class="text-muted">Generatorn f칬rs칬ker h친lla sig under budgeten</small>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" name="prefer_cheaper" id="preferCheaper">
                                <label class="form-check-label" for="preferCheaper">
                                    <i class="bi bi-piggy-bank me-2 text-success"></i>
                                    Prioritera billigare produkter
                                    <small class="text-muted d-block">V칛ljer billigare alternativ 칛ven om de 칛r n친got s칛mre p친 n칛ring</small>
                                </label>
                            </div>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- NYTT: M친ltidsval -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="bi bi-clock me-2"></i>Vilka m친ltider vill du planera?
                            </label>
                            <div class="row g-2">
                                <div class="col-6 col-md-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="include_breakfast" id="includeBreakfast" checked>
                                        <label class="form-check-label" for="includeBreakfast">
                                            游깬 Frukost
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="include_lunch" id="includeLunch" checked>
                                        <label class="form-check-label" for="includeLunch">
                                            游 Lunch
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="include_dinner" id="includeDinner" checked>
                                        <label class="form-check-label" for="includeDinner">
                                            游깿 Middag
                                        </label>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input" type="checkbox" name="include_snacks" id="includeSnacks">
                                        <label class="form-check-label" for="includeSnacks">
                                            游꼝 Mellanm친l
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <small class="text-muted">Avmarkera m친ltider du inte beh칬ver (t.ex. om du inte 칛ter frukost)</small>
                        </div>
                        
                        <hr class="my-4">
                        
                        <!-- NYTT: AI-receptgenerering -->
                        <div class="mb-4">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" name="use_ai_recipes" id="useAiRecipes" role="switch">
                                <label class="form-check-label fw-bold" for="useAiRecipes">
                                    <i class="bi bi-stars me-2 text-warning"></i>AI-genererade recept
                                </label>
                            </div>
                            <div id="aiRecipeInfo" class="mt-2 p-3 bg-light rounded" style="display: none;">
                                <p class="mb-2 small">
                                    <i class="bi bi-info-circle me-1 text-info"></i>
                                    Med AI-recept skapas en veckomeny med riktiga recept f칬rst, sedan genereras ink칬pslistan fr친n ingredienserna.
                                </p>
                                <ul class="small mb-0">
                                    <li>游꼽 F친 konkreta receptf칬rslag f칬r varje m친ltid</li>
                                    <li>游닇 Ingredienser h칛mtas fr친n vald butik</li>
                                    <li>游댃 Generera om tills du blir n칬jd</li>
                                </ul>
                                {% if not ai_available %}
                                <div class="alert alert-warning mt-2 mb-0 py-2 small">
                                    <i class="bi bi-exclamation-triangle me-1"></i>
                                    AI-tj칛nsten 칛r inte konfigurerad. Kontakta administrat칬ren.
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <hr class="my-4">

                        <div class="mb-4">
                            <label class="form-label fw-bold">F칬redragen butik</label>
                            <select class="form-select" name="store">
                                <option value="">Visa b칛sta pris (alla butiker)</option>
                                {% for store in stores %}
                                <option value="{{ store }}">{{ store }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                V칛lj en butik f칬r att se priser enbart d칛rifr친n
                            </small>
                        </div>

                        <button type="submit" class="btn btn-warning btn-lg w-100" {% if not plans %}disabled{% endif %}>
                            <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
                            <i class="bi bi-magic me-2"></i>Generera ink칬pslista
                        </button>
                    </form>
                </div>
            </div>

            <div id="generatedResult" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle me-2"></i>Lista genererad!
                        </h5>
                    </div>
                    <div class="card-body">
                        <p id="resultSummary"></p>
                        
                        <!-- N칛ringsuppfyllnad -->
                        <div id="nutritionCoverage" class="mb-4">
                            <h6 class="mb-3"><i class="bi bi-pie-chart me-2"></i>N칛ringsuppfyllnad</h6>
                            <div class="row g-2">
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-2 bg-light rounded">
                                        <div class="fw-bold" id="caloriesCoverage">-</div>
                                        <small class="text-muted">Kalorier</small>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div class="progress-bar bg-success" id="caloriesBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-2 bg-light rounded">
                                        <div class="fw-bold" id="proteinCoverage">-</div>
                                        <small class="text-muted">Protein</small>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div class="progress-bar bg-info" id="proteinBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-2 bg-light rounded">
                                        <div class="fw-bold" id="carbsCoverage">-</div>
                                        <small class="text-muted">Kolhydrater</small>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div class="progress-bar bg-warning" id="carbsBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-2 bg-light rounded">
                                        <div class="fw-bold" id="fatCoverage">-</div>
                                        <small class="text-muted">Fett</small>
                                        <div class="progress mt-1" style="height: 4px;">
                                            <div class="progress-bar bg-danger" id="fatBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-2 text-muted small" id="nutritionDetails"></div>
                        </div>
                        
                        <div id="budgetWarning" class="alert alert-warning d-none mb-3">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            <span id="budgetWarningText"></span>
                        </div>
                        <a href="/shopping-list" class="btn btn-success">
                            <i class="bi bi-cart3 me-2"></i>Visa ink칬pslista
                        </a>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h6><i class="bi bi-lightbulb me-2 text-warning"></i>Hur fungerar genereringen?</h6>
                    <ol class="text-muted small mb-0">
                        <li>Appen analyserar din n칛ringsplan och ber칛knar dagliga behov</li>
                        <li>Allergier och kostrestriktioner filtreras automatiskt</li>
                        <li>Basvaror s칬ks f칬r att hitta aktuella priser</li>
                        <li>Produkter v칛ljs f칬r att matcha dina n칛ringsbehov och budget</li>
                        <li>En ink칬pslista skapas med optimala produkter och kvantiteter</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function setDays(days) {
    document.querySelector('[name="days"]').value = days;
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

function changeHouseholdSize(delta) {
    const input = document.querySelector('[name="household_size"]');
    const newVal = Math.max(1, Math.min(10, parseInt(input.value) + delta));
    input.value = newVal;
}

// Toggle AI recipe info
document.getElementById('useAiRecipes').addEventListener('change', function() {
    document.getElementById('aiRecipeInfo').style.display = this.checked ? 'block' : 'none';
});

document.getElementById('generateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const button = form.querySelector('button[type="submit"]');
    
    form.classList.add('loading');
    button.disabled = true;
    
    const formData = new FormData(form);
    const budget = formData.get('budget');
    
    const data = {
        plan_id: parseInt(formData.get('plan_id')),
        days: parseInt(formData.get('days')),
        store: formData.get('store') || null,
        household_size: parseInt(formData.get('household_size')) || 1,
        budget: budget ? parseFloat(budget) : null,
        prefer_cheaper: formData.get('prefer_cheaper') === 'on',
        // Nya f칛lt
        include_breakfast: formData.get('include_breakfast') === 'on',
        include_lunch: formData.get('include_lunch') === 'on',
        include_dinner: formData.get('include_dinner') === 'on',
        include_snacks: formData.get('include_snacks') === 'on',
        use_ai_recipes: formData.get('use_ai_recipes') === 'on'
    };
    
    // Kontrollera att minst en m친ltid 칛r vald
    if (!data.include_breakfast && !data.include_lunch && !data.include_dinner && !data.include_snacks) {
        alert('Du m친ste v칛lja minst en m친ltid!');
        form.classList.remove('loading');
        button.disabled = false;
        return;
    }
    
    try {
        const response = await fetch('/api/generate-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            const householdSize = data.household_size;
            const costPerPerson = householdSize > 1 ? ((result.total_cost || 0) / householdSize).toFixed(2) : null;
            
            let summaryHtml = `
                <strong>${result.name}</strong><br>
                ${result.items?.length || 0} produkter 췅 
                Totalt ca <strong>${(result.total_cost || 0).toFixed(2)} kr</strong>
            `;
            
            if (costPerPerson) {
                summaryHtml += `<br><small class="text-muted">Ca ${costPerPerson} kr per person</small>`;
            }
            
            document.getElementById('resultSummary').innerHTML = summaryHtml;
            
            // Visa n칛ringsuppfyllnad
            if (result.nutrition_coverage) {
                const cov = result.nutrition_coverage;
                document.getElementById('caloriesCoverage').textContent = cov.calories + '%';
                document.getElementById('proteinCoverage').textContent = cov.protein + '%';
                document.getElementById('carbsCoverage').textContent = cov.carbs + '%';
                document.getElementById('fatCoverage').textContent = cov.fat + '%';
                
                document.getElementById('caloriesBar').style.width = Math.min(100, cov.calories) + '%';
                document.getElementById('proteinBar').style.width = Math.min(100, cov.protein) + '%';
                document.getElementById('carbsBar').style.width = Math.min(100, cov.carbs) + '%';
                document.getElementById('fatBar').style.width = Math.min(100, cov.fat) + '%';
                
                // F칛rgs칛tt baserat p친 uppfyllnad
                ['calories', 'protein', 'carbs', 'fat'].forEach(nutrient => {
                    const bar = document.getElementById(nutrient + 'Bar');
                    const val = cov[nutrient];
                    if (val >= 90) bar.className = 'progress-bar bg-success';
                    else if (val >= 70) bar.className = 'progress-bar bg-warning';
                    else bar.className = 'progress-bar bg-danger';
                });
            }
            
            // Visa detaljer om totaler vs m친l
            if (result.nutrition_totals && result.nutrition_targets) {
                const totals = result.nutrition_totals;
                const targets = result.nutrition_targets;
                document.getElementById('nutritionDetails').innerHTML = `
                    Totalt: ${totals.calories} / ${targets.calories} kcal 췅 
                    ${totals.protein} / ${targets.protein}g protein 췅 
                    ${totals.carbs} / ${targets.carbs}g kolhydrater
                `;
            }
            
            // Visa budget-varning om 칬ver budget
            const budgetWarning = document.getElementById('budgetWarning');
            if (data.budget && result.total_cost > data.budget) {
                document.getElementById('budgetWarningText').textContent = 
                    `Totalkostnaden (${result.total_cost.toFixed(2)} kr) 칬verstiger din budget (${data.budget} kr). Du kan byta ut produkter manuellt f칬r att s칛nka kostnaden.`;
                budgetWarning.classList.remove('d-none');
            } else {
                budgetWarning.classList.add('d-none');
            }
            
            document.getElementById('generatedResult').style.display = 'block';
            document.getElementById('generatedResult').scrollIntoView({ behavior: 'smooth' });
        } else {
            const error = await response.json();
            alert('Ett fel uppstod: ' + (error.error || 'Ok칛nt fel'));
        }
    } catch (error) {
        alert('Ett fel uppstod: ' + error.message);
    } finally {
        form.classList.remove('loading');
        button.disabled = false;
    }
});
</script>
{% endblock %}
