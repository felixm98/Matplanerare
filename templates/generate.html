{% extends "base.html" %}

{% block title %}Generera inköpslista - Matplanerare{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="bi bi-magic me-2"></i>Generera inköpslista automatiskt
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">
                        Välj en näringsplan och hur länge du vill handla för. Appen genererar
                        en optimerad inköpslista baserad på dina näringsbehov.
                    </p>

                    <form id="generateForm">
                        <div class="mb-4">
                            <label class="form-label fw-bold">Välj näringsplan</label>
                            {% if plans %}
                            <select class="form-select form-select-lg" name="plan_id" required>
                                {% for plan in plans %}
                                <option value="{{ plan.id }}">
                                    {{ plan.name }} ({{ plan.calories_target }} kcal/dag)
                                </option>
                                {% endfor %}
                            </select>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                Du har ingen näringsplan. 
                                <a href="/plan">Skapa en först</a>.
                            </div>
                            {% endif %}
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Tidsperiod</label>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="input-group">
                                        <input type="number" class="form-control form-control-lg" 
                                               name="days" value="7" min="1" max="30">
                                        <span class="input-group-text">dagar</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="btn-group w-100" role="group">
                                        <button type="button" class="btn btn-outline-secondary" onclick="setDays(3)">3 dagar</button>
                                        <button type="button" class="btn btn-outline-secondary active" onclick="setDays(7)">1 vecka</button>
                                        <button type="button" class="btn btn-outline-secondary" onclick="setDays(14)">2 veckor</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label fw-bold">Föredragen butik</label>
                            <select class="form-select" name="store">
                                <option value="">Visa bästa pris (alla butiker)</option>
                                {% for store in stores %}
                                <option value="{{ store }}">{{ store }}</option>
                                {% endfor %}
                            </select>
                            <small class="text-muted">
                                Välj en butik för att se priser enbart därifrån
                            </small>
                        </div>

                        <button type="submit" class="btn btn-warning btn-lg w-100" {% if not plans %}disabled{% endif %}>
                            <span class="loading-spinner spinner-border spinner-border-sm me-2" role="status"></span>
                            <i class="bi bi-magic me-2"></i>Generera inköpslista
                        </button>
                    </form>
                </div>
            </div>

            <div id="generatedResult" class="mt-4" style="display: none;">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-check-circle me-2"></i>Lista genererad!
                        </h5>
                    </div>
                    <div class="card-body">
                        <p id="resultSummary"></p>
                        <a href="/shopping-list" class="btn btn-success">
                            <i class="bi bi-cart3 me-2"></i>Visa inköpslista
                        </a>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-body">
                    <h6><i class="bi bi-lightbulb me-2 text-warning"></i>Hur fungerar genereringen?</h6>
                    <ol class="text-muted small mb-0">
                        <li>Appen analyserar din näringsplan och beräknar dagliga behov</li>
                        <li>Basvaror söks från matspar.se för att hitta aktuella priser</li>
                        <li>Produkter väljs för att matcha dina näringsbehov</li>
                        <li>En inköpslista skapas med optimala produkter och kvantiteter</li>
                    </ol>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function setDays(days) {
    document.querySelector('[name="days"]').value = days;
    document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

document.getElementById('generateForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const form = e.target;
    const button = form.querySelector('button[type="submit"]');
    
    form.classList.add('loading');
    button.disabled = true;
    
    const formData = new FormData(form);
    const data = {
        plan_id: parseInt(formData.get('plan_id')),
        days: parseInt(formData.get('days')),
        store: formData.get('store') || null
    };
    
    try {
        const response = await fetch('/api/generate-list', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            const result = await response.json();
            
            document.getElementById('resultSummary').innerHTML = `
                <strong>${result.name}</strong><br>
                ${result.items?.length || 0} produkter · 
                Totalt ca <strong>${(result.total_cost || 0).toFixed(2)} kr</strong>
            `;
            document.getElementById('generatedResult').style.display = 'block';
            document.getElementById('generatedResult').scrollIntoView({ behavior: 'smooth' });
        } else {
            alert('Ett fel uppstod vid generering. Försök igen.');
        }
    } catch (error) {
        alert('Ett fel uppstod: ' + error.message);
    } finally {
        form.classList.remove('loading');
        button.disabled = false;
    }
});
</script>
{% endblock %}
