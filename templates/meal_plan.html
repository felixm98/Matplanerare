{% extends "base.html" %}

{% block title %}M√•ltidsplan - {{ shopping_list.name }}{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row mb-4">
        <div class="col">
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="/shopping-list">Ink√∂pslistor</a></li>
                    <li class="breadcrumb-item active">M√•ltidsplan</li>
                </ol>
            </nav>
            <h2>
                <i class="bi bi-calendar3 me-2"></i>M√•ltidsplan
                {% if has_ai_recipes %}
                <span class="badge bg-info ms-2" style="font-size: 0.5em;">
                    <i class="bi bi-robot me-1"></i>AI-recept
                </span>
                {% endif %}
            </h2>
            <p class="text-muted">
                {{ shopping_list.name }} ¬∑ {{ shopping_list.days }} dag{{ 'ar' if shopping_list.days > 1 else '' }}
                {% if plan %}
                ¬∑ M√•l: {{ plan.calories_target }} kcal/dag
                {% endif %}
            </p>
        </div>
        <div class="col-auto d-flex gap-2">
            {% if has_ai_recipes %}
            <button class="btn btn-outline-primary" onclick="regenerateRecipes()" id="regenerateBtn">
                <i class="bi bi-arrow-clockwise me-2"></i>Generera om recept
            </button>
            {% endif %}
            <a href="{{ url_for('shopping_list_view', list_id=shopping_list.id) }}" class="btn btn-success">
                <i class="bi bi-phone me-2"></i>Handla-vy
            </a>
        </div>
    </div>

    <!-- Inst√§llningar -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-4">
                    <label class="form-label fw-bold">Antal m√•ltider per dag</label>
                    <select class="form-select" id="mealsPerDay" onchange="updateMealPlan()">
                        <option value="3">3 m√•ltider (frukost, lunch, middag)</option>
                        <option value="4">4 m√•ltider (+ mellanm√•l)</option>
                        <option value="5" selected>5 m√•ltider (+ 2 mellanm√•l)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label fw-bold">Visa dag</label>
                    <select class="form-select" id="selectedDay" onchange="showDay(this.value)">
                        {% for day in range(1, shopping_list.days + 1) %}
                        <option value="{{ day }}">Dag {{ day }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4 text-end">
                    {% if plan %}
                    <div class="mt-3">
                        <span class="badge bg-primary fs-6">
                            <i class="bi bi-fire me-1"></i>M√•l: {{ plan.calories_target }} kcal
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Daglig sammanfattning -->
    <div class="card mb-4 border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-graph-up me-2"></i>Dagens n√§ring
                <span id="dayLabel" class="badge bg-light text-primary ms-2">Dag 1</span>
            </h5>
        </div>
        <div class="card-body">
            <div class="row text-center">
                <div class="col">
                    <div class="fs-3 fw-bold text-primary" id="totalCalories">0</div>
                    <small class="text-muted">kcal</small>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-primary" id="caloriesBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="col">
                    <div class="fs-3 fw-bold text-success" id="totalProtein">0g</div>
                    <small class="text-muted">protein</small>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-success" id="proteinBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="col">
                    <div class="fs-3 fw-bold text-warning" id="totalCarbs">0g</div>
                    <small class="text-muted">kolhydrater</small>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-warning" id="carbsBar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="col">
                    <div class="fs-3 fw-bold text-danger" id="totalFat">0g</div>
                    <small class="text-muted">fett</small>
                    <div class="progress mt-2" style="height: 8px;">
                        <div class="progress-bar bg-danger" id="fatBar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- M√•ltider -->
    <div id="mealsContainer">
        <!-- Fylls i med JavaScript -->
    </div>

    <!-- Tips -->
    <div class="card mt-4 bg-light">
        <div class="card-body">
            <h6><i class="bi bi-lightbulb text-warning me-2"></i>Tips f√∂r balanserad kost</h6>
            <ul class="mb-0 small text-muted">
                <li>F√∂rdela proteinet j√§mnt √∂ver dagens m√•ltider f√∂r b√§sta upptag</li>
                <li>√Ñt gr√∂nsaker och frukt till varje m√•ltid f√∂r vitaminer och mineraler</li>
                <li>Kolhydrater ger energi - √§t mer vid aktiva dagar</li>
                <li>Mellanm√•l hj√§lper att h√•lla blodsockret stabilt</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ============== DATA FR√ÖN SERVERN ==============
const shoppingList = {{ shopping_list_json|safe }};
const planData = {{ plan_json|safe }};
const days = {{ shopping_list.days }};
const householdSize = {{ shopping_list.household_size or 1 }};
const listId = {{ shopping_list.id }};

// AI-recept data
const hasAIRecipes = {{ 'true' if has_ai_recipes else 'false' }};
const aiRecipes = {{ recipes_json|safe }};

// H√§mta m√•l fr√•n plan - hantera att daily_targets inneh√•ller objekt med {value, mode}
function getTargetValue(planData, nutrient, defaultValue) {
    if (!planData) return defaultValue;
    
    // F√∂rs√∂k h√§mta fr√•n daily_targets f√∂rst (objekt med value property)
    if (planData.daily_targets && planData.daily_targets[nutrient]) {
        const target = planData.daily_targets[nutrient];
        // Om det √§r ett objekt med value-property, anv√§nd det
        if (typeof target === 'object' && target.value !== undefined) {
            return target.value;
        }
        // Om det √§r ett nummer direkt
        if (typeof target === 'number') {
            return target;
        }
    }
    
    // Fallback till direkta properties (bak√•tkompatibilitet)
    if (planData[nutrient] !== undefined && typeof planData[nutrient] === 'number') {
        return planData[nutrient];
    }
    
    // Sista fallback: target-suffix
    const targetKey = nutrient + '_target';
    if (planData[targetKey] !== undefined) {
        return planData[targetKey];
    }
    
    return defaultValue;
}

const plan = {
    calories_target: getTargetValue(planData, 'calories', 2000),
    protein_target: getTargetValue(planData, 'protein', 50),
    carbs_target: getTargetValue(planData, 'carbs', 250),
    fat_target: getTargetValue(planData, 'fat', 65)
};

console.log('Plan targets:', plan); // Debug

// ============== BER√ÑKNA TILLG√ÑNGLIG MAT ==============
function parseWeight(weightStr) {
    if (!weightStr) return 500;
    weightStr = String(weightStr).toLowerCase().replace(/\s/g, '');
    
    let match = weightStr.match(/(\d+(?:[.,]\d+)?)\s*kg/);
    if (match) return parseFloat(match[1].replace(',', '.')) * 1000;
    
    match = weightStr.match(/(\d+(?:[.,]\d+)?)\s*g/);
    if (match) return parseFloat(match[1].replace(',', '.'));
    
    match = weightStr.match(/(\d+(?:[.,]\d+)?)\s*l/);
    if (match) return parseFloat(match[1].replace(',', '.')) * 1000;
    
    match = weightStr.match(/(\d+)\s*st/);
    if (match) return parseInt(match[1]) * 60;
    
    match = weightStr.match(/(\d+)\s*dl/);
    if (match) return parseInt(match[1]) * 100;
    
    return 500;
}

// M√•ltidsklassificering
function getMealType(category) {
    const types = {
        'mj√∂lk': 'breakfast', 'havregryn': 'breakfast', 'yoghurt': 'breakfast',
        'kvarg': 'snack', '√§gg': 'breakfast', 'br√∂d': 'breakfast',
        'ost': 'breakfast', 'sm√∂r': 'breakfast',
        'kyckling': 'protein', 'kycklingfil√©': 'protein', 'lax': 'protein', 
        'n√∂tf√§rs': 'protein', 'fl√§sk': 'protein', 'fl√§skfil√©': 'protein',
        'korv': 'protein', 'tofu': 'protein',
        'ris': 'carbs', 'pasta': 'carbs', 'potatis': 'carbs',
        'tomat': 'vegetables', 'gurka': 'vegetables', 'sallad': 'vegetables',
        'morot': 'vegetables', 'l√∂k': 'vegetables', 'broccoli': 'vegetables',
        'paprika': 'vegetables',
        'banan': 'snack', '√§pple': 'snack', 'apelsin': 'snack', 'avokado': 'snack',
        'gr√§dde': 'fat', 'olja': 'fat',
        'linser': 'protein', 'b√∂nor': 'protein'
    };
    return types[category] || 'other';
}

// Ber√§kna total mat och n√§ring tillg√§nglig
const availableFood = [];
let totalAvailableCalories = 0;
let totalAvailableProtein = 0;
let totalAvailableCarbs = 0;
let totalAvailableFat = 0;

shoppingList.items.forEach(item => {
    if (!item.product) return;
    
    const packGrams = parseWeight(item.product.weight);
    const totalGrams = packGrams * item.quantity;
    const nutr = item.product.nutrition || {};
    
    // Ber√§kna total n√§ring fr√•n denna produkt
    const factor = totalGrams / 100;
    const calories = (nutr.calories || 0) * factor;
    const protein = (nutr.protein || 0) * factor;
    const carbs = (nutr.carbs || 0) * factor;
    const fat = (nutr.fat || 0) * factor;
    
    totalAvailableCalories += calories;
    totalAvailableProtein += protein;
    totalAvailableCarbs += carbs;
    totalAvailableFat += fat;
    
    const cat = item.product.category || '√∂vrigt';
    const mealType = getMealType(cat);
    
    availableFood.push({
        name: item.product.name,
        category: cat,
        mealType: mealType,
        totalGrams: totalGrams,
        nutrition: nutr,
        totalCalories: calories,
        totalProtein: protein,
        totalCarbs: carbs,
        totalFat: fat,
        dailyGrams: totalGrams / days,
        dailyCalories: calories / days,
        dailyProtein: protein / days,
        dailyCarbs: carbs / days,
        dailyFat: fat / days
    });
});

// Kalorier per dag baserat p√• ink√∂pt mat
const dailyCaloriesFromFood = totalAvailableCalories / days;
const dailyProteinFromFood = totalAvailableProtein / days;
const dailyCarbsFromFood = totalAvailableCarbs / days;
const dailyFatFromFood = totalAvailableFat / days;

// T√§ckning av m√•l
const calorieCoverage = (dailyCaloriesFromFood / plan.calories_target * 100);

// M√•ltidsnamn
const mealNames = {
    3: ['üåÖ Frukost', 'üåû Lunch', 'üåô Middag'],
    4: ['üåÖ Frukost', 'üåû Lunch', 'üçé Mellanm√•l', 'üåô Middag'],
    5: ['üåÖ Frukost', 'ü•§ F√∂rmiddagsmellanm√•l', 'üåû Lunch', 'üçé Eftermiddagsmellanm√•l', 'üåô Middag']
};

// ============== GENERERA M√ÖLTIDSPLAN ==============
// F√∂rdela mat f√∂r att N√Ö kalorim√•let f√∂r varje m√•ltid
function generateMealPlan(dayNumber, mealsCount) {
    const meals = [];
    const names = mealNames[mealsCount];
    
    // Kalorif√∂rdelning per m√•ltidstyp
    const distributions = {
        3: { 'Frukost': 0.25, 'Lunch': 0.40, 'Middag': 0.35 },
        4: { 'Frukost': 0.25, 'Lunch': 0.35, 'Mellanm√•l': 0.10, 'Middag': 0.30 },
        5: { 'Frukost': 0.20, 'F√∂rmiddagsmellanm√•l': 0.10, 'Lunch': 0.30, 'Eftermiddagsmellanm√•l': 0.10, 'Middag': 0.30 }
    };
    
    const targetDailyCalories = plan.calories_target;
    const targetDailyProtein = plan.protein_target;
    
    names.forEach((mealName, index) => {
        let distKey = Object.keys(distributions[mealsCount]).find(k => mealName.includes(k));
        const fraction = distKey ? distributions[mealsCount][distKey] : 0.2;
        
        const targetCal = Math.round(targetDailyCalories * fraction);
        
        const mealProducts = [];
        let mealCalories = 0, mealProtein = 0, mealCarbs = 0, mealFat = 0;
        
        const isBreakfast = mealName.includes('Frukost');
        const isSnack = mealName.toLowerCase().includes('mellanm√•l');
        const isMainMeal = mealName.includes('Lunch') || mealName.includes('Middag');
        
        // L√§gg till mat - returnerar kalorier som lades till
        function addFood(food, grams) {
            if (grams < 5) return 0;
            
            const factor = grams / 100;
            const portionCal = (food.nutrition.calories || 0) * factor;
            const portionProtein = (food.nutrition.protein || 0) * factor;
            const portionCarbs = (food.nutrition.carbs || 0) * factor;
            const portionFat = (food.nutrition.fat || 0) * factor;
            
            mealProducts.push({
                name: food.name,
                category: food.category,
                portion: formatPortion(grams, food.category),
                calories: Math.round(portionCal)
            });
            
            mealCalories += portionCal;
            mealProtein += portionProtein;
            mealCarbs += portionCarbs;
            mealFat += portionFat;
            return portionCal;
        }
        
        // Ber√§kna hur mycket gram som beh√∂vs f√∂r X kalorier
        function gramsForCalories(food, targetCalories) {
            const calPer100g = food.nutrition.calories || 100;
            return (targetCalories / calPer100g) * 100;
        }
        
        if (isBreakfast) {
            // Frukost: f√∂rdela kalorier mellan produkter
            const breakfastItems = availableFood.filter(f => f.mealType === 'breakfast');
            const fruits = availableFood.filter(f => f.mealType === 'snack' && ['banan', '√§pple'].includes(f.category));
            
            if (breakfastItems.length > 0) {
                // Ge 70% till huvudfrukost, 30% till tillbeh√∂r
                const mainCalories = targetCal * 0.7;
                const sideCalories = targetCal * 0.3;
                
                // Huvudfrukost (havregryn etc) - f√∂rsta produkten f√•r mest
                const mainItem = breakfastItems[0];
                const mainGrams = Math.min(gramsForCalories(mainItem, mainCalories), mainItem.dailyGrams * 0.8);
                addFood(mainItem, mainGrams);
                
                // √ñvriga frukostprodukter delar resten
                const remaining = targetCal - mealCalories;
                const others = breakfastItems.slice(1);
                if (others.length > 0 && remaining > 50) {
                    const perItem = remaining / others.length;
                    others.forEach(item => {
                        const grams = Math.min(gramsForCalories(item, perItem), item.dailyGrams * 0.6);
                        addFood(item, grams);
                    });
                }
            }
            
            // Frukt om vi har utrymme
            if (fruits.length > 0 && mealCalories < targetCal * 0.9) {
                const remaining = targetCal - mealCalories;
                const grams = Math.min(gramsForCalories(fruits[0], remaining), 150);
                addFood(fruits[0], grams);
            }
            
        } else if (isSnack) {
            const snacks = availableFood.filter(f => f.mealType === 'snack');
            const dairy = availableFood.filter(f => f.category === 'kvarg' || f.category === 'yoghurt');
            
            // Mellanm√•l - anv√§nd hela budgeten
            const allSnacks = [...snacks, ...dairy];
            if (allSnacks.length > 0) {
                const snackIndex = mealName.includes('Eftermiddag') ? 1 : 0;
                const item = allSnacks[snackIndex % allSnacks.length];
                const grams = Math.min(gramsForCalories(item, targetCal), item.dailyGrams * 0.8);
                addFood(item, grams);
            }
            
        } else if (isMainMeal) {
            // Huvudm√•ltid: protein 40%, kolhydrater 40%, gr√∂nsaker 15%, fett 5%
            const proteins = availableFood.filter(f => f.mealType === 'protein');
            const carbs = availableFood.filter(f => f.mealType === 'carbs');
            const veggies = availableFood.filter(f => f.mealType === 'vegetables');
            const fats = availableFood.filter(f => f.mealType === 'fat');
            const mealIndex = mealName.includes('Lunch') ? 0 : 1;
            
            const proteinBudget = targetCal * 0.35;
            const carbBudget = targetCal * 0.40;
            const vegBudget = targetCal * 0.15;
            const fatBudget = targetCal * 0.10;
            
            // Protein
            if (proteins.length > 0) {
                const protein = proteins[mealIndex % proteins.length];
                const grams = Math.min(gramsForCalories(protein, proteinBudget), protein.dailyGrams * 0.7);
                addFood(protein, grams);
            }
            
            // Kolhydrater
            if (carbs.length > 0) {
                const carb = carbs[mealIndex % carbs.length];
                const grams = Math.min(gramsForCalories(carb, carbBudget), carb.dailyGrams * 0.7);
                addFood(carb, grams);
            }
            
            // Gr√∂nsaker - l√§gg till flera
            if (veggies.length > 0) {
                const vegPerItem = vegBudget / Math.min(veggies.length, 3);
                veggies.slice(0, 3).forEach((veg, i) => {
                    if ((i + mealIndex) % 2 === 0 || veggies.length <= 2) {
                        const grams = Math.min(gramsForCalories(veg, vegPerItem), veg.dailyGrams * 0.5);
                        addFood(veg, grams);
                    }
                });
            }
            
            // Fett
            if (fats.length > 0) {
                const fat = fats[0];
                const grams = Math.min(gramsForCalories(fat, fatBudget), fat.dailyGrams * 0.5);
                addFood(fat, grams);
            }
            
            // Om vi fortfarande √§r under m√•let, √∂ka kolhydrater/protein
            if (mealCalories < targetCal * 0.85) {
                const remaining = targetCal - mealCalories;
                if (carbs.length > 0) {
                    const carb = carbs[mealIndex % carbs.length];
                    const extraGrams = gramsForCalories(carb, remaining * 0.6);
                    addFood(carb, Math.min(extraGrams, 100));
                }
                if (proteins.length > 0 && mealCalories < targetCal * 0.9) {
                    const protein = proteins[mealIndex % proteins.length];
                    const extraGrams = gramsForCalories(protein, targetCal - mealCalories);
                    addFood(protein, Math.min(extraGrams, 80));
                }
            }
        }
        
        meals.push({
            name: mealName,
            targetCalories: targetCal,
            products: mealProducts,
            totals: {
                calories: Math.round(mealCalories),
                protein: Math.round(mealProtein),
                carbs: Math.round(mealCarbs),
                fat: Math.round(mealFat)
            }
        });
    });
    
    return meals;
}

function formatPortion(grams, category) {
    if (grams <= 0) return '-';
    
    const formats = {
        'mj√∂lk': g => `${Math.round(g/10)} dl`,
        '√§gg': g => `${Math.round(g/60)} st`,
        'br√∂d': g => `${Math.round(g/40)} skivor`,
        'ost': g => `${Math.round(g)}g`,
        'sm√∂r': g => `${Math.round(g)}g`,
        'banan': g => g > 100 ? '1 st' : '¬Ω st',
        '√§pple': g => g > 150 ? '1 st' : '¬Ω st'
    };
    
    if (formats[category]) {
        return formats[category](grams);
    }
    
    return `${Math.round(grams)}g`;
}

// ============== VISA M√ÖLTIDSPLAN ==============
function showDay(dayNumber) {
    const mealsCount = parseInt(document.getElementById('mealsPerDay').value);
    const meals = generateMealPlan(dayNumber, mealsCount);
    
    document.getElementById('dayLabel').textContent = `Dag ${dayNumber}`;
    
    let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
    let html = '';
    
    // Visa info om t√§ckning - varning endast om maten INTE r√§cker
    if (calorieCoverage < 90) {
        html += `
            <div class="alert alert-warning mb-3">
                <i class="bi bi-exclamation-triangle me-2"></i>
                <strong>Obs!</strong> Den ink√∂pta maten t√§cker endast ca ${Math.round(calorieCoverage)}% av ditt dagliga kalorim√•l.
                Du kan beh√∂va handla mer mat.
            </div>
        `;
    } else if (calorieCoverage >= 100) {
        html += `
            <div class="alert alert-success mb-3">
                <i class="bi bi-check-circle me-2"></i>
                Du har k√∂pt tillr√§ckligt med mat f√∂r att n√• dina n√§ringsm√•l. 
                Maten r√§cker till ${Math.round(calorieCoverage)}% av ditt kaloribehov per dag.
            </div>
        `;
    }
    
    meals.forEach((meal, index) => {
        const isMainMeal = meal.name.includes('Frukost') || meal.name.includes('Lunch') || meal.name.includes('Middag');
        
        totalCalories += meal.totals.calories;
        totalProtein += meal.totals.protein;
        totalCarbs += meal.totals.carbs;
        totalFat += meal.totals.fat;
        
        html += `
            <div class="card mb-3 ${isMainMeal ? '' : 'border-secondary'}">
                <div class="card-header ${isMainMeal ? 'bg-success text-white' : 'bg-light'}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${meal.name}</h5>
                        <span class="badge ${isMainMeal ? 'bg-light text-success' : 'bg-secondary'}">
                            ${meal.totals.calories} kcal
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h6 class="text-muted mb-2">F√∂rslag:</h6>
                            <ul class="list-unstyled">
        `;
        
        if (meal.products.length === 0) {
            html += `<li class="text-muted mb-2">Inga produkter</li>`;
        } else {
            meal.products.forEach(product => {
                const icon = getCategoryIcon(product.category);
                html += `
                    <li class="mb-2 d-flex align-items-center">
                        <span class="me-2">${icon}</span>
                        <span class="flex-grow-1">
                            <strong>${product.name}</strong><br>
                            <small class="text-muted">${product.portion}</small>
                        </span>
                        <span class="badge bg-light text-dark">${product.calories} kcal</span>
                    </li>
                `;
            });
        }
        
        html += `
                            </ul>
                        </div>
                        <div class="col-md-4">
                            <div class="bg-light rounded p-3">
                                <h6 class="text-muted mb-2">M√•ltidsn√§ring</h6>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Kalorier:</span>
                                    <strong class="text-primary">${meal.totals.calories} kcal</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Protein:</span>
                                    <strong class="text-success">${meal.totals.protein}g</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-1">
                                    <span>Kolhydrater:</span>
                                    <strong class="text-warning">${meal.totals.carbs}g</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Fett:</span>
                                    <strong class="text-danger">${meal.totals.fat}g</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('mealsContainer').innerHTML = html;
    
    document.getElementById('totalCalories').textContent = totalCalories;
    document.getElementById('totalProtein').textContent = totalProtein + 'g';
    document.getElementById('totalCarbs').textContent = totalCarbs + 'g';
    document.getElementById('totalFat').textContent = totalFat + 'g';
    
    document.getElementById('caloriesBar').style.width = Math.min(100, (totalCalories / plan.calories_target) * 100) + '%';
    document.getElementById('proteinBar').style.width = Math.min(100, (totalProtein / plan.protein_target) * 100) + '%';
    document.getElementById('carbsBar').style.width = Math.min(100, (totalCarbs / plan.carbs_target) * 100) + '%';
    document.getElementById('fatBar').style.width = Math.min(100, (totalFat / plan.fat_target) * 100) + '%';
}

function getCategoryIcon(category) {
    const icons = {
        'mj√∂lk': 'ü•õ', 'havregryn': 'ü•£', 'yoghurt': 'ü•õ', 'kvarg': 'ü•õ',
        'br√∂d': 'üçû', '√§gg': 'ü•ö', 'ost': 'üßÄ', 'sm√∂r': 'üßà',
        'kyckling': 'üçó', 'kycklingfil√©': 'üçó', 'lax': 'üêü',
        'n√∂tf√§rs': 'ü•©', 'fl√§sk': 'ü•ì', 'fl√§skfil√©': 'ü•ì', 'korv': 'üå≠', 'tofu': 'üßä',
        'ris': 'üçö', 'pasta': 'üçù', 'potatis': 'ü•î',
        'tomat': 'üçÖ', 'gurka': 'ü•í', 'sallad': 'ü•¨', 'morot': 'ü•ï',
        'l√∂k': 'üßÖ', 'broccoli': 'ü•¶', 'paprika': 'ü´ë',
        'banan': 'üçå', '√§pple': 'üçé', 'apelsin': 'üçä', 'avokado': 'ü•ë',
        'gr√§dde': 'ü•õ', 'olja': 'ü´í', 'linser': 'ü´ò', 'b√∂nor': 'ü´ò', 'n√∂tter': 'ü•ú'
    };
    return icons[category] || 'üçΩÔ∏è';
}

function updateMealPlan() {
    const dayNumber = parseInt(document.getElementById('selectedDay').value);
    if (hasAIRecipes && aiRecipes.length > 0) {
        showAIRecipesForDay(dayNumber);
    } else {
        showDay(dayNumber);
    }
}

// ============== AI-RECEPT FUNKTIONER ==============
function showAIRecipesForDay(dayNumber) {
    const dayRecipes = aiRecipes.filter(r => r.day === dayNumber);
    
    document.getElementById('dayLabel').textContent = `Dag ${dayNumber}`;
    
    let totalCalories = 0, totalProtein = 0, totalCarbs = 0, totalFat = 0;
    let html = '';
    
    // Gruppera recept efter m√•ltidstyp
    const mealOrder = ['frukost', 'mellanm√•l_fm', 'lunch', 'mellanm√•l_em', 'middag'];
    const mealLabels = {
        'frukost': 'üåÖ Frukost',
        'mellanm√•l_fm': 'ü•§ F√∂rmiddagsmellanm√•l',
        'lunch': 'üåû Lunch',
        'mellanm√•l_em': 'üçé Eftermiddagsmellanm√•l',
        'middag': 'üåô Middag'
    };
    
    html += `
        <div class="alert alert-info mb-3">
            <i class="bi bi-robot me-2"></i>
            <strong>AI-genererade recept</strong> - Dessa recept har skapats baserat p√• dina preferenser och ingredienser fr√•n Matspar.
            <button class="btn btn-sm btn-outline-info float-end" onclick="regenerateRecipes()">
                <i class="bi bi-arrow-clockwise me-1"></i>Generera nya recept
            </button>
        </div>
    `;
    
    mealOrder.forEach(mealType => {
        const recipe = dayRecipes.find(r => r.meal_type === mealType);
        if (!recipe) return;
        
        const isMainMeal = ['frukost', 'lunch', 'middag'].includes(mealType);
        const mealCalories = recipe.calories_per_portion * (householdSize || 1);
        
        // Ber√§kna ungef√§rlig n√§ring baserat p√• kalorier
        const mealProtein = Math.round(mealCalories * 0.15 / 4); // 15% av kalorier fr√•n protein
        const mealCarbs = Math.round(mealCalories * 0.50 / 4); // 50% fr√•n kolhydrater
        const mealFat = Math.round(mealCalories * 0.35 / 9); // 35% fr√•n fett
        
        totalCalories += mealCalories;
        totalProtein += mealProtein;
        totalCarbs += mealCarbs;
        totalFat += mealFat;
        
        const ingredients = recipe.ingredients || [];
        const instructions = recipe.instructions || [];
        
        html += `
            <div class="card mb-3 ${isMainMeal ? '' : 'border-secondary'}">
                <div class="card-header ${isMainMeal ? 'bg-success text-white' : 'bg-light'}">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">${mealLabels[mealType] || mealType}</h5>
                        <span class="badge ${isMainMeal ? 'bg-light text-success' : 'bg-secondary'}">
                            ${Math.round(mealCalories)} kcal
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <h4 class="text-primary mb-3">
                        <i class="bi bi-book me-2"></i>${recipe.name}
                    </h4>
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2"><i class="bi bi-basket me-1"></i>Ingredienser (${recipe.portions || 1} portioner):</h6>
                            <ul class="list-group list-group-flush mb-3">
        `;
        
        ingredients.forEach(ing => {
            html += `
                <li class="list-group-item py-2">
                    <i class="bi bi-check-circle text-success me-2"></i>${ing}
                </li>
            `;
        });
        
        html += `
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-muted mb-2">
                                <i class="bi bi-clock me-1"></i>Tillagning (${recipe.prep_time_minutes || '?'} min):
                            </h6>
                            <ol class="list-group list-group-numbered list-group-flush">
        `;
        
        instructions.forEach(step => {
            html += `
                <li class="list-group-item py-2">${step}</li>
            `;
        });
        
        html += `
                            </ol>
                        </div>
                    </div>
                    <div class="bg-light rounded p-3 mt-3">
                        <div class="row text-center">
                            <div class="col-3">
                                <div class="fw-bold text-primary">${Math.round(mealCalories)}</div>
                                <small class="text-muted">kcal</small>
                            </div>
                            <div class="col-3">
                                <div class="fw-bold text-success">~${mealProtein}g</div>
                                <small class="text-muted">protein</small>
                            </div>
                            <div class="col-3">
                                <div class="fw-bold text-warning">~${mealCarbs}g</div>
                                <small class="text-muted">kolhydrater</small>
                            </div>
                            <div class="col-3">
                                <div class="fw-bold text-danger">~${mealFat}g</div>
                                <small class="text-muted">fett</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    document.getElementById('mealsContainer').innerHTML = html;
    
    // Uppdatera daglig sammanfattning
    document.getElementById('totalCalories').textContent = totalCalories;
    document.getElementById('totalProtein').textContent = totalProtein + 'g';
    document.getElementById('totalCarbs').textContent = totalCarbs + 'g';
    document.getElementById('totalFat').textContent = totalFat + 'g';
    
    document.getElementById('caloriesBar').style.width = Math.min(100, (totalCalories / plan.calories_target) * 100) + '%';
    document.getElementById('proteinBar').style.width = Math.min(100, (totalProtein / plan.protein_target) * 100) + '%';
    document.getElementById('carbsBar').style.width = Math.min(100, (totalCarbs / plan.carbs_target) * 100) + '%';
    document.getElementById('fatBar').style.width = Math.min(100, (totalFat / plan.fat_target) * 100) + '%';
}

async function regenerateRecipes() {
    const btn = document.getElementById('regenerateBtn');
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Genererar...';
    }
    
    try {
        const response = await fetch(`/api/shopping-lists/${listId}/regenerate-recipes`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.error) {
            alert('Kunde inte generera nya recept: ' + data.error);
        } else {
            // Ladda om sidan f√∂r att se nya recept
            window.location.reload();
        }
    } catch (err) {
        console.error('Fel vid regenerering:', err);
        alert('Ett fel uppstod. F√∂rs√∂k igen.');
    } finally {
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = '<i class="bi bi-arrow-clockwise me-2"></i>Generera om recept';
        }
    }
}

document.addEventListener('DOMContentLoaded', () => {
    console.log('Tillg√§nglig mat per dag:', Math.round(dailyCaloriesFromFood), 'kcal');
    console.log('M√•l per dag:', plan.calories_target, 'kcal');
    console.log('T√§ckning:', Math.round(calorieCoverage), '%');
    console.log('Har AI-recept:', hasAIRecipes);
    
    // Om vi har AI-recept, visa dem ist√§llet
    if (hasAIRecipes && aiRecipes.length > 0) {
        showAIRecipesForDay(1);
    } else {
        showDay(1);
    }
});
</script>
{% endblock %}
